{% extends "layout.html" %}

{% block title %}User Management - Notiva Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Admin Navigation -->
    <div class="admin-nav">
        <ul class="nav nav-pills justify-content-center">
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('admin_dashboard') }}">
                    <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('admin_notes') }}">
                    <i class="fas fa-file-alt me-1"></i>Notes Management
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('admin_doubts') }}">
                    <i class="fas fa-question-circle me-1"></i>Doubts
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('admin_ads') }}">
                    <i class="fas fa-bullhorn me-1"></i>Ads Manager
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('admin_academic') }}">
                    <i class="fas fa-university me-1"></i>Academic
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="{{ url_for('admin_users') }}">
                    <i class="fas fa-users me-1"></i>Users
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('admin_analytics') }}">
                    <i class="fas fa-chart-bar me-1"></i>Analytics
                </a>
            </li>
        </ul>
    </div>

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-users me-2 text-primary"></i>User Management
            </h2>
            <p class="text-light mb-0">Manage platform users and administrative access</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-success" onclick="exportData('csv')">
                <i class="fas fa-download me-2"></i>Export Users
            </button>
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-filter me-2"></i>Filter Users
                </button>
                <ul class="dropdown-menu dropdown-menu-dark">
                    <li><a class="dropdown-item" href="?role=all">All Users</a></li>
                    <li><a class="dropdown-item" href="?role=admin">Admins Only</a></li>
                    <li><a class="dropdown-item" href="?role=user">Regular Users</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="?sort=recent">Recent First</a></li>
                    <li><a class="dropdown-item" href="?sort=oldest">Oldest First</a></li>
                    <li><a class="dropdown-item" href="?sort=name">Sort by Name</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ users | length }}</h3>
                    <p class="mb-0">Total Users</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">{{ users | selectattr('is_admin', 'equalto', True) | list | length }}</h3>
                    <p class="mb-0">Administrators</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info">{{ users | selectattr('is_admin', 'equalto', False) | list | length }}</h3>
                    <p class="mb-0">Regular Users</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning">{{ users | selectattr('created_at') | select('>=', (moment().subtract(30, 'days'))) | list | length }}</h3>
                    <p class="mb-0">New (30 days)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Bulk Actions -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search users by name or email...">
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group" role="group">
                        <input type="checkbox" class="btn-check" id="selectAll">
                        <label class="btn btn-outline-primary" for="selectAll">
                            <i class="fas fa-check-square me-1"></i>Select All
                        </label>
                    </div>
                    <div class="btn-group ms-2" role="group">
                        <button class="btn btn-success" id="bulkAdminBtn" style="display: none;" onclick="bulkPromoteToAdmin()">
                            <i class="fas fa-user-shield me-1"></i>Make Admin
                        </button>
                        <button class="btn btn-warning" id="bulkUserBtn" style="display: none;" onclick="bulkDemoteToUser()">
                            <i class="fas fa-user me-1"></i>Remove Admin
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="card">
        <div class="card-body">
            {% if users %}
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th width="50px">
                                    <input type="checkbox" id="selectAllTable">
                                </th>
                                <th>User Details</th>
                                <th>Role</th>
                                <th>Activity Stats</th>
                                <th>Registration</th>
                                <th width="200px">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                                <tr data-user-id="{{ user.id }}">
                                    <td>
                                        <input type="checkbox" class="item-checkbox" value="{{ user.id }}" 
                                               {% if user.id == current_user.id %}disabled{% endif %}>
                                    </td>
                                    <td>
                                        <div>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-placeholder me-3">
                                                    <i class="fas fa-user-circle fa-2x text-primary"></i>
                                                </div>
                                                <div>
                                                    <strong>{{ user.name }}</strong>
                                                    {% if user.id == current_user.id %}
                                                        <span class="badge bg-info ms-2">You</span>
                                                    {% endif %}
                                                    <div class="small text-light">{{ user.email }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if user.is_admin %}
                                            <span class="badge bg-success fs-6">
                                                <i class="fas fa-user-shield me-1"></i>Administrator
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary fs-6">
                                                <i class="fas fa-user me-1"></i>Regular User
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="small">
                                            <div class="mb-1">
                                                <i class="fas fa-upload text-success me-1"></i>
                                                {{ user.materials | length }} uploads
                                            </div>
                                            <div class="mb-1">
                                                <i class="fas fa-download text-primary me-1"></i>
                                                {{ user.materials | sum(attribute='download_count') }} downloads
                                            </div>
                                            <div class="mb-1">
                                                <i class="fas fa-question-circle text-info me-1"></i>
                                                {{ user.doubts | length }} doubts
                                            </div>
                                            <div>
                                                <i class="fas fa-star text-warning me-1"></i>
                                                {{ user.ratings | length }} ratings
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="small">
                                            <div><strong>Joined:</strong></div>
                                            <div>{{ user.created_at.strftime('%B %d, %Y') }}</div>
                                            <div class="text-muted">{{ user.created_at.strftime('%I:%M %p') }}</div>
                                            
                                            {% if user.created_at >= (moment().subtract(7, 'days')) %}
                                                <span class="badge bg-success mt-1">New User</span>
                                            {% elif user.created_at >= (moment().subtract(30, 'days')) %}
                                                <span class="badge bg-info mt-1">Recent</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group-vertical w-100" role="group">
                                            {% if user.id != current_user.id %}
                                                <a href="{{ url_for('toggle_admin', user_id=user.id) }}" 
                                                   class="btn btn-{{ 'warning' if user.is_admin else 'success' }} btn-sm">
                                                    <i class="fas fa-{{ 'user-minus' if user.is_admin else 'user-shield' }} me-1"></i>
                                                    {{ 'Remove Admin' if user.is_admin else 'Make Admin' }}
                                                </a>
                                            {% else %}
                                                <button class="btn btn-secondary btn-sm" disabled>
                                                    <i class="fas fa-lock me-1"></i>Cannot Edit Self
                                                </button>
                                            {% endif %}
                                            
                                            <button class="btn btn-info btn-sm" 
                                                    onclick="viewUserDetails({{ user.id }}, '{{ user.name|e }}', '{{ user.email|e }}', {{ user.materials | length }}, {{ user.doubts | length }}, '{{ user.created_at.isoformat() }}')">
                                                <i class="fas fa-eye me-1"></i>View Details
                                            </button>
                                            
                                            <button class="btn btn-outline-primary btn-sm" 
                                                    onclick="sendNotification({{ user.id }}, '{{ user.name|e }}')">
                                                <i class="fas fa-bell me-1"></i>Send Message
                                            </button>
                                            
                                            {% if user.id != current_user.id and not user.is_admin %}
                                                <button class="btn btn-outline-danger btn-sm" 
                                                        onclick="suspendUser({{ user.id }}, '{{ user.name|e }}')">
                                                    <i class="fas fa-user-times me-1"></i>Suspend
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-users text-muted" style="font-size: 4rem; opacity: 0.3;"></i>
                    <h4 class="mt-3 text-light">No Users Found</h4>
                    <p class="text-light">No users match your current filter criteria.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2 text-primary"></i>User Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="userDetailsContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Send Notification Modal -->
<div class="modal fade" id="notificationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-bell me-2 text-warning"></i>Send Notification
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="notificationForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Recipient:</label>
                        <div id="notificationRecipient" class="fw-bold text-primary"></div>
                    </div>
                    <div class="mb-3">
                        <label for="notificationTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="notificationTitle" required
                               placeholder="Notification title...">
                    </div>
                    <div class="mb-3">
                        <label for="notificationMessage" class="form-label">Message</label>
                        <textarea class="form-control" id="notificationMessage" rows="4" required
                                  placeholder="Your message to the user..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-paper-plane me-2"></i>Send Notification
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
<script>
function viewUserDetails(userId, name, email, materialsCount, doubtsCount, createdAt) {
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-primary mb-3">Basic Information</h6>
                <div class="mb-3">
                    <strong>Name:</strong><br>
                    ${name}
                </div>
                <div class="mb-3">
                    <strong>Email:</strong><br>
                    ${email}
                </div>
                <div class="mb-3">
                    <strong>User ID:</strong><br>
                    #${userId}
                </div>
                <div class="mb-3">
                    <strong>Registration Date:</strong><br>
                    ${new Date(createdAt).toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="text-success mb-3">Activity Statistics</h6>
                <div class="mb-3">
                    <strong>Materials Uploaded:</strong><br>
                    <span class="badge bg-success">${materialsCount}</span>
                </div>
                <div class="mb-3">
                    <strong>Doubts Asked:</strong><br>
                    <span class="badge bg-info">${doubtsCount}</span>
                </div>
                <div class="mb-3">
                    <strong>Account Status:</strong><br>
                    <span class="badge bg-success">Active</span>
                </div>
                <div class="mb-3">
                    <strong>Last Activity:</strong><br>
                    <span class="text-muted">Recently active</span>
                </div>
            </div>
        </div>
        
        <hr class="my-4">
        
        <div class="row">
            <div class="col-12">
                <h6 class="text-warning mb-3">Recent Activity</h6>
                <div class="text-muted">
                    <i class="fas fa-info-circle me-2"></i>
                    Detailed activity logs would be displayed here in a full implementation.
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('userDetailsContent').innerHTML = content;
    new bootstrap.Modal(document.getElementById('userDetailsModal')).show();
}

function sendNotification(userId, userName) {
    document.getElementById('notificationRecipient').textContent = userName;
    document.getElementById('notificationForm').setAttribute('data-user-id', userId);
    new bootstrap.Modal(document.getElementById('notificationModal')).show();
}

function suspendUser(userId, userName) {
    if (confirm(`Are you sure you want to suspend the user "${userName}"? This will temporarily disable their account.`)) {
        // Implement suspension logic here
        showNotification(`User "${userName}" has been suspended.`, 'warning');
    }
}

function bulkPromoteToAdmin() {
    const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert('Please select users to promote to admin');
        return;
    }
    
    if (confirm(`Are you sure you want to grant admin privileges to ${selectedCheckboxes.length} selected users?`)) {
        const userIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        console.log('Bulk promoting users to admin:', userIds);
        showNotification(`${selectedCheckboxes.length} users promoted to admin.`, 'success');
    }
}

function bulkDemoteToUser() {
    const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert('Please select admin users to demote');
        return;
    }
    
    if (confirm(`Are you sure you want to remove admin privileges from ${selectedCheckboxes.length} selected users?`)) {
        const userIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        console.log('Bulk demoting users from admin:', userIds);
        showNotification(`${selectedCheckboxes.length} users demoted to regular users.`, 'info');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const name = row.querySelector('strong').textContent.toLowerCase();
            const email = row.querySelector('.text-light').textContent.toLowerCase();
            
            if (name.includes(query) || email.includes(query)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
    
    // Checkbox selection
    const selectAllTable = document.getElementById('selectAllTable');
    const selectAll = document.getElementById('selectAll');
    const itemCheckboxes = document.querySelectorAll('.item-checkbox:not([disabled])');
    
    [selectAllTable, selectAll].forEach(checkbox => {
        if (checkbox) {
            checkbox.addEventListener('change', function() {
                itemCheckboxes.forEach(cb => cb.checked = this.checked);
                updateBulkButtons();
            });
        }
    });
    
    itemCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateBulkButtons);
    });
    
    function updateBulkButtons() {
        const selectedCount = document.querySelectorAll('.item-checkbox:checked').length;
        const bulkAdminBtn = document.getElementById('bulkAdminBtn');
        const bulkUserBtn = document.getElementById('bulkUserBtn');
        
        if (selectedCount > 0) {
            bulkAdminBtn.style.display = 'inline-block';
            bulkUserBtn.style.display = 'inline-block';
            bulkAdminBtn.innerHTML = `<i class="fas fa-user-shield me-1"></i>Make Admin (${selectedCount})`;
            bulkUserBtn.innerHTML = `<i class="fas fa-user me-1"></i>Remove Admin (${selectedCount})`;
        } else {
            bulkAdminBtn.style.display = 'none';
            bulkUserBtn.style.display = 'none';
        }
    }
    
    // Notification form submission
    document.getElementById('notificationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const userId = this.getAttribute('data-user-id');
        const title = document.getElementById('notificationTitle').value;
        const message = document.getElementById('notificationMessage').value;
        
        // Here you would implement the actual notification sending
        console.log('Sending notification to user:', userId, { title, message });
        
        showNotification('Notification sent successfully!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('notificationModal')).hide();
        
        // Reset form
        this.reset();
    });
    
    // Reset notification modal when closed
    document.getElementById('notificationModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('notificationForm').reset();
    });
});
</script>
{% endblock %}
